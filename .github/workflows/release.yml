name: Release

on:
  push:
    tags: ["v*"]

env:
  APP_NAME: OpenWhisper
  SCHEME: OpenWhisper

jobs:
  release:
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          brew install xcodegen create-dmg

      - name: Import Developer ID certificate
        env:
          P12_BASE64: ${{ secrets.DEVELOPER_ID_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.DEVELOPER_ID_P12_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$P12_BASE64" | base64 --decode > $RUNNER_TEMP/cert.p12
          security import $RUNNER_TEMP/cert.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Build and archive
        run: |
          xcodebuild archive \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/$APP_NAME.xcarchive" \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }}

      - name: Export archive
        run: |
          cat > $RUNNER_TEMP/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>developer-id</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/$APP_NAME.xcarchive" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
            -exportPath "$RUNNER_TEMP/export"

      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create zip for notarization
          ditto -c -k --keepParent "$RUNNER_TEMP/export/$APP_NAME.app" "$RUNNER_TEMP/$APP_NAME-notarize.zip"

          xcrun notarytool submit "$RUNNER_TEMP/$APP_NAME-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "$RUNNER_TEMP/export/$APP_NAME.app"

      - name: Create DMG
        run: |
          create-dmg \
            --volname "$APP_NAME" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$APP_NAME.app" 150 190 \
            --app-drop-link 450 190 \
            "$RUNNER_TEMP/$APP_NAME.dmg" \
            "$RUNNER_TEMP/export/$APP_NAME.app"

      - name: Sign DMG with Sparkle
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Find sign_update in resolved SPM packages
          SIGN_UPDATE=$(find .build -name "sign_update" -type f 2>/dev/null | head -1)
          if [ -z "$SIGN_UPDATE" ]; then
            echo "sign_update not found, building to resolve packages..."
            xcodebuild -scheme "$SCHEME" -configuration Release -derivedDataPath .build build
            SIGN_UPDATE=$(find .build -name "sign_update" -type f 2>/dev/null | head -1)
          fi

          echo "$SPARKLE_PRIVATE_KEY" | "$SIGN_UPDATE" --ed-key-file - "$RUNNER_TEMP/$APP_NAME.dmg" > "$RUNNER_TEMP/sparkle-signature.txt"
          cat "$RUNNER_TEMP/sparkle-signature.txt"

      - name: Generate appcast item
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          DMG_SIZE=$(stat -f%z "$RUNNER_TEMP/$APP_NAME.dmg")
          SIGNATURE=$(cat "$RUNNER_TEMP/sparkle-signature.txt" | grep -o 'sparkle:edSignature="[^"]*"' | cut -d'"' -f2)
          DATE=$(date -R)

          cat > "$RUNNER_TEMP/appcast-item.xml" <<EOF
          <item>
            <title>Version $VERSION</title>
            <pubDate>$DATE</pubDate>
            <sparkle:version>${CURRENT_PROJECT_VERSION:-1}</sparkle:version>
            <sparkle:shortVersionString>$VERSION</sparkle:shortVersionString>
            <enclosure
              url="https://github.com/richardwu/openwhisper/releases/download/${GITHUB_REF_NAME}/$APP_NAME.dmg"
              length="$DMG_SIZE"
              type="application/octet-stream"
              sparkle:edSignature="$SIGNATURE"
            />
          </item>
          EOF

          echo "--- Appcast item ---"
          cat "$RUNNER_TEMP/appcast-item.xml"

      - name: Upload DMG to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "$GITHUB_REF_NAME" "$RUNNER_TEMP/$APP_NAME.dmg" --clobber
