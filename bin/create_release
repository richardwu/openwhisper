#!/usr/bin/env bash
set -euo pipefail

APP_NAME="OpenWhisper"
SCHEME="OpenWhisper"
REPO="richardwu/openwhisper"

# --- Parse args ---
if [ $# -lt 1 ]; then
  echo "Usage: bin/create_release <VERSION>"
  echo "  e.g. bin/create_release 0.2.0"
  exit 1
fi

VERSION="$1"
TAG="v${VERSION}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
BUILD_DIR="$PROJECT_DIR/.release"
RELEASES_DIR="$HOME/.openwhisper-releases"

cd "$PROJECT_DIR"

# --- Validate environment ---
echo "==> Checking prerequisites..."

command -v xcodegen >/dev/null || { echo "Error: xcodegen not found (brew install xcodegen)"; exit 1; }
command -v create-dmg >/dev/null || { echo "Error: create-dmg not found (brew install create-dmg)"; exit 1; }
command -v gh >/dev/null || { echo "Error: gh not found (brew install gh)"; exit 1; }
command -v xcrun >/dev/null || { echo "Error: xcrun not found (install Xcode)"; exit 1; }

# Check for Developer ID cert
if ! security find-identity -v -p codesigning | grep -q "Developer ID Application"; then
  echo "Error: No 'Developer ID Application' certificate found in keychain."
  echo "Create one in Xcode → Settings → Accounts → Manage Certificates."
  exit 1
fi

TEAM_ID=$(security find-certificate -c "Developer ID Application" -p | openssl x509 -noout -subject 2>/dev/null | sed -n 's/.*OU=\([^,]*\).*/\1/p')
echo "    Team ID: $TEAM_ID"
echo "    Version: $VERSION (tag: $TAG)"

# Check for Sparkle public key
SPARKLE_PUBLIC_KEY=$(.build/SourcePackages/artifacts/sparkle/Sparkle/bin/generate_keys -p 2>/dev/null || true)
if [ -z "$SPARKLE_PUBLIC_KEY" ]; then
  echo "Error: No Sparkle EdDSA key found. Run: .build/SourcePackages/artifacts/sparkle/Sparkle/bin/generate_keys"
  exit 1
fi
echo "    Sparkle public key: ${SPARKLE_PUBLIC_KEY:0:20}..."

# --- Ensure model is available ---
echo ""
echo "==> Ensuring whisper model is available..."
"$PROJECT_DIR/bin/download_model"

# --- Clean and build ---
echo ""
echo "==> Generating Xcode project..."
xcodegen generate

echo "==> Archiving Release build..."
rm -rf "$BUILD_DIR"
mkdir -p "$BUILD_DIR"

xcodebuild archive \
  -scheme "$SCHEME" \
  -configuration Release \
  -archivePath "$BUILD_DIR/$APP_NAME.xcarchive" \
  CODE_SIGN_IDENTITY="Developer ID Application" \
  CODE_SIGN_STYLE=Manual \
  DEVELOPMENT_TEAM="$TEAM_ID" \
  SPARKLE_PUBLIC_EDKEY="$SPARKLE_PUBLIC_KEY" \
  MARKETING_VERSION="$VERSION" \
  | tail -5

# --- Export ---
echo "==> Exporting archive..."
cat > "$BUILD_DIR/ExportOptions.plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>method</key>
  <string>developer-id</string>
  <key>teamID</key>
  <string>$TEAM_ID</string>
</dict>
</plist>
EOF

xcodebuild -exportArchive \
  -archivePath "$BUILD_DIR/$APP_NAME.xcarchive" \
  -exportOptionsPlist "$BUILD_DIR/ExportOptions.plist" \
  -exportPath "$BUILD_DIR/export" \
  | tail -3

APP_PATH="$BUILD_DIR/export/$APP_NAME.app"

# --- Notarize ---
echo "==> Notarizing..."
echo "    (You may be prompted for Apple ID credentials on first run."
echo "     Store them with: xcrun notarytool store-credentials)"

ditto -c -k --keepParent "$APP_PATH" "$BUILD_DIR/$APP_NAME-notarize.zip"

xcrun notarytool submit "$BUILD_DIR/$APP_NAME-notarize.zip" \
  --keychain-profile "notarytool" \
  --wait

echo "==> Stapling notarization ticket..."
xcrun stapler staple "$APP_PATH"

# --- DMG ---
echo "==> Creating DMG..."
create-dmg \
  --volname "$APP_NAME" \
  --window-pos 200 120 \
  --window-size 600 400 \
  --icon-size 100 \
  --icon "$APP_NAME.app" 150 190 \
  --app-drop-link 450 190 \
  "$BUILD_DIR/$APP_NAME.dmg" \
  "$APP_PATH" \
  || true  # create-dmg exits 2 on success when no background image is set

if [ ! -f "$BUILD_DIR/$APP_NAME.dmg" ]; then
  echo "Error: DMG creation failed"
  exit 1
fi

# --- Sparkle sign ---
echo "==> Signing DMG with Sparkle..."
SIGN_UPDATE=$(find .build -path "*/artifacts/sparkle/Sparkle/bin/sign_update" -type f 2>/dev/null | head -1)
if [ -z "$SIGN_UPDATE" ]; then
  echo "Error: sign_update not found. Run xcodebuild -resolvePackageDependencies first."
  exit 1
fi

SPARKLE_SIG=$("$SIGN_UPDATE" "$BUILD_DIR/$APP_NAME.dmg" 2>&1)
echo "    $SPARKLE_SIG"

ED_SIGNATURE=$(echo "$SPARKLE_SIG" | sed -n 's/.*sparkle:edSignature="\([^"]*\)".*/\1/p')
DMG_SIZE=$(stat -f%z "$BUILD_DIR/$APP_NAME.dmg")

# --- Delta updates ---
echo "==> Generating delta updates..."
BUILD_NUMBER=$(grep 'CURRENT_PROJECT_VERSION' project.yml | head -1 | sed 's/.*: *"\{0,1\}\([^"]*\)"\{0,1\}/\1/')

BINARY_DELTA=$(find .build -path "*/artifacts/sparkle/Sparkle/bin/BinaryDelta" -type f 2>/dev/null | head -1)
DELTA_FILES=()
DELTA_XML=""

if [ -z "$BINARY_DELTA" ]; then
  echo "    Warning: BinaryDelta not found, skipping delta generation."
elif [ ! -d "$RELEASES_DIR" ]; then
  echo "    No previous releases found in $RELEASES_DIR, skipping deltas."
else
  for OLD_APP_DIR in "$RELEASES_DIR"/v*/; do
    [ -d "$OLD_APP_DIR" ] || continue
    OLD_APP="$OLD_APP_DIR/$APP_NAME.app"
    [ -d "$OLD_APP" ] || continue

    OLD_VERSION=$(basename "$OLD_APP_DIR")  # e.g. v0.1.0
    OLD_BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$OLD_APP/Contents/Info.plist" 2>/dev/null || true)

    if [ -z "$OLD_BUILD" ]; then
      echo "    Skipping $OLD_VERSION: could not read build number"
      continue
    fi

    if [ "$OLD_BUILD" = "$BUILD_NUMBER" ]; then
      echo "    Skipping $OLD_VERSION: same build number ($OLD_BUILD)"
      continue
    fi

    DELTA_FILENAME="$APP_NAME-${OLD_BUILD}-to-${BUILD_NUMBER}.delta"
    DELTA_PATH="$BUILD_DIR/$DELTA_FILENAME"

    echo "    Creating delta: $OLD_VERSION (build $OLD_BUILD) → $VERSION (build $BUILD_NUMBER)..."
    "$BINARY_DELTA" create "$OLD_APP" "$APP_PATH" "$DELTA_PATH"

    DELTA_SIG_OUTPUT=$("$SIGN_UPDATE" "$DELTA_PATH" 2>&1)
    DELTA_ED_SIG=$(echo "$DELTA_SIG_OUTPUT" | sed -n 's/.*sparkle:edSignature="\([^"]*\)".*/\1/p')
    DELTA_SIZE=$(stat -f%z "$DELTA_PATH")

    echo "    Delta: $DELTA_FILENAME ($DELTA_SIZE bytes)"

    DELTA_FILES+=("$DELTA_PATH")
    DELTA_XML+="
        <enclosure
          url=\"https://github.com/$REPO/releases/download/$TAG/$DELTA_FILENAME\"
          sparkle:deltaFrom=\"$OLD_BUILD\"
          length=\"$DELTA_SIZE\"
          type=\"application/octet-stream\"
          sparkle:edSignature=\"$DELTA_ED_SIG\"
        />"
  done
fi

if [ ${#DELTA_FILES[@]} -eq 0 ]; then
  echo "    No deltas generated."
fi

# --- Appcast ---
echo "==> Generating appcast.xml..."
DATE=$(date -R)

DELTAS_SECTION=""
if [ -n "$DELTA_XML" ]; then
  DELTAS_SECTION="
      <sparkle:deltas>$DELTA_XML
      </sparkle:deltas>"
fi

cat > "$BUILD_DIR/appcast.xml" <<EOF
<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
  <channel>
    <title>$APP_NAME</title>
    <item>
      <title>Version $VERSION</title>
      <pubDate>$DATE</pubDate>
      <sparkle:version>$BUILD_NUMBER</sparkle:version>
      <sparkle:shortVersionString>$VERSION</sparkle:shortVersionString>
      <enclosure
        url="https://github.com/$REPO/releases/download/$TAG/$APP_NAME.dmg"
        length="$DMG_SIZE"
        type="application/octet-stream"
        sparkle:edSignature="$ED_SIGNATURE"
      />${DELTAS_SECTION}
    </item>
  </channel>
</rss>
EOF

echo "    Appcast written to $BUILD_DIR/appcast.xml"

# --- Archive .app for future deltas ---
echo "==> Archiving .app for future delta generation..."
mkdir -p "$RELEASES_DIR/$TAG"
cp -R "$APP_PATH" "$RELEASES_DIR/$TAG/$APP_NAME.app"
echo "    Stored at $RELEASES_DIR/$TAG/$APP_NAME.app"

# --- Done ---
cp "$BUILD_DIR/appcast.xml" "$PROJECT_DIR/appcast.xml"

UPLOAD_FILES="$BUILD_DIR/$APP_NAME.dmg"
if [ ${#DELTA_FILES[@]} -gt 0 ]; then
  for df in "${DELTA_FILES[@]}"; do
    UPLOAD_FILES+=" $df"
  done
fi

echo ""
echo "=== Build $VERSION complete ==="
echo "  DMG:     $BUILD_DIR/$APP_NAME.dmg"
if [ ${#DELTA_FILES[@]} -gt 0 ]; then
  echo "  Deltas:  ${#DELTA_FILES[@]} delta file(s) in $BUILD_DIR/"
fi
echo "  Appcast: appcast.xml (copied to repo root)"
echo ""
echo "Next steps:"
echo "  git tag $TAG && git push origin $TAG"
echo "  gh release create $TAG --title '$APP_NAME $VERSION' --generate-notes $UPLOAD_FILES"
echo "  git add appcast.xml && git commit -m 'Update appcast.xml for $VERSION' && git push origin main"
echo ""
echo "NOTE: First time? Store notarization credentials with:"
echo "  xcrun notarytool store-credentials notarytool"
